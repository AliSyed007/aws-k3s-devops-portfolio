stages:
  - build
  - deploy

variables:
  # Image tag per commit for immutable deploys
  IMAGE: "$CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA"

build:
  stage: build
  script:
    - set -euo pipefail
    - podman version
    - echo "$CI_REGISTRY_PASSWORD" | podman login "$CI_REGISTRY" -u "$CI_REGISTRY_USER" --password-stdin
    - podman build -t "$IMAGE" .
    - podman push "$IMAGE"
    # Optional: keep a 'latest' tag on main for convenience
    - |
      if [ "$CI_COMMIT_BRANCH" = "main" ]; then
        podman tag "$IMAGE" "$CI_REGISTRY_IMAGE:latest"
        podman push "$CI_REGISTRY_IMAGE:latest"
      fi

deploy:
  stage: deploy
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  script:
    - set -euo pipefail
    - kubectl version --client
    # ensure baseline resources exist
    - kubectl -n app apply -f k8s/
    # update deployment image to the freshly built tag
    - kubectl -n app set image deployment/myapp myapp="$IMAGE"
    # verify rollout
    - kubectl -n app rollout status deployment/myapp --timeout=180s
    - kubectl -n app get pods -o wide

