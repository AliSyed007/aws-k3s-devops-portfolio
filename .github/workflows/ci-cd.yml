name: build-and-deploy

on:
  push:
    branches: ["main"]

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute lowercase image name
        id: vars
        run: |
          set -euo pipefail
          REPO_LC="$(echo "${GITHUB_REPOSITORY}" | tr '[:upper:]' '[:lower:]')"
          echo "repo_lc=$REPO_LC" >> "$GITHUB_OUTPUT"

      - name: Podman login to GHCR (fail-fast if secrets missing)
        env:
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          GHCR_USER: ${{ secrets.GHCR_USER }}
        run: |
          set -euo pipefail

          if [ -z "${GHCR_USER:-}" ]; then
            echo "ERROR: GHCR_USER secret is missing or empty"
            exit 1
          fi

          if [ -z "${GHCR_TOKEN:-}" ]; then
            echo "ERROR: GHCR_TOKEN secret is missing or empty"
            exit 1
          fi

          echo "$GHCR_TOKEN" | podman login ghcr.io -u "$GHCR_USER" --password-stdin

      - name: Build and push image
        env:
          REPO_LC: ${{ steps.vars.outputs.repo_lc }}
          SHA: ${{ github.sha }}
        run: |
          set -euo pipefail
          IMAGE="ghcr.io/${REPO_LC}:${SHA}"
          IMAGE_LATEST="ghcr.io/${REPO_LC}:latest"

          podman build -t "$IMAGE" .
          podman push "$IMAGE"

          podman tag "$IMAGE" "$IMAGE_LATEST"
          podman push "$IMAGE_LATEST"

  deploy:
    runs-on: self-hosted
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute lowercase image name
        id: vars
        run: |
          set -euo pipefail
          REPO_LC="$(echo "${GITHUB_REPOSITORY}" | tr '[:upper:]' '[:lower:]')"
          echo "repo_lc=$REPO_LC" >> "$GITHUB_OUTPUT"

      - name: Deploy to k3s
        env:
          REPO_LC: ${{ steps.vars.outputs.repo_lc }}
          SHA: ${{ github.sha }}
        run: |
          set -euo pipefail
          IMAGE="ghcr.io/${REPO_LC}:${SHA}"

          kubectl -n app apply -f k8s/
          kubectl -n app set image deployment/myapp myapp="$IMAGE"
          kubectl -n app rollout status deployment/myapp --timeout=180s
          kubectl -n app get pods -o wide
